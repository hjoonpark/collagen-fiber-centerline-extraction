# Collagen Fiber Centerline Extraction Network

PyTorch implementation of the **collagen fiber centerline extraction network** proposed in\
[**Variational auto-encoder for collagen fiber centerline generation and extraction in fibrotic cancer tissues**](),\
Medical Image Analysis 2022 (under review).

![figure](/etc/figures/pipeline.png)

## Related repository
 - [Analysis repository](https://github.com/uw-loci/collagen-fiber-metrics): Collagen fiber extraction and analysis in cancer tissue microenvironment.
 - [DuoVAE](https://github.com/hjoonpark/duovae) for VAE benchmark datasets: a VAE-framework for property-controlled data generation.

---

## Installation

## Train

Command format is `python train.py <stage-number> --model-dir <model-directory>`, for example

### Stage I.
**DuoVAE** for generating collagen centerlines with desired centerline properties:

    python train.py 1

### Stage II.
**cGAN** for generating collagen images from collagen centerlines:

    python train.py 2

### Stage III.

**UNet** for extracting collagen centerlines from collagen images:

    python train.py 3

The outputs will be saved in the directories `output/stage1`, `output/stage2`, and `output/stage3`.

To resume from a saved checkpoint, pass in `--model-dir` argument to a directory where the saved model (`.pt` files) is located and (optionally) set the number of starting epoch, for example

    # resume from saved model in 'output/stage1/model' at epoch 1000
    python train.py 1 --model-dir "output/stage1/model" --starting-epoch 1000



## Results

### Stage 1 and 2

![figure](/etc/figures/result_stage1_stage2.png)

The figure shows representative outputs of the property-controlled data generation of DuoVAE on the collagen fiber dataset. The outputs are grouped into 6 panels according to the fiber properties: 

- (a) orientation (from left-oriented to right-oriented), 
- (b) alignment (from well-aligned to randomly organized), 
- (c) density (from sparse to dense), 
- (d) waviness (from straight to wavy), 
- (e) average length (from short to long), and 
- (f) length variation (from uniform lengths to random lengths). 

The first rows in each panel are the fiber centerlines generated by **DuoVAE**, and the second rows are the corresponding collage image generated by the **cGAN**. The generated centerlines exhibit the different values of fiber properties specified in the generating process.

### Stage 3

![figure](/etc/figures/result_stage3.png)

Representative results of input images captured using different objective magnifications (20× and 40×) are shown in the figure. The results show that the centerlines produced by the centerline extraction networks are consistently more similar to the ground truth annotations.


## Citation

    coming